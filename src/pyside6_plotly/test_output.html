<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <!-- <script src="{self.plotly_js_url}"></script> -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
        body, html {{ margin: 0; padding: 0; height: 100%; }}
        #plot {{ width: 100%; height: 100%; }}
    </style>
    
</head>
<body>
    <script type="text/javascript">{self.plotly_js}</script>

    <div id="plot"></div>
    <script>
        window.PLOTLYENV=window.PLOTLYENV || {{}}; 
        // Initialize Qt web channel
        var callbacks;
        var plotData = {plot_json};
        var plotDiv = document.getElementById('plot');
        

        
        document.addEventListener("DOMContentLoaded", function() {{
            new QWebChannel(qt.webChannelTransport, function(channel) {{
                callbacks = channel.objects.callbacks;

                function set_handlers(el) {{
                    // forward events
                    for (const name of [
                        // source: https://plotly.com/javascript/plotlyjs-events/
                        "plotly_click",
                        "plotly_legendclick",
                        "plotly_selecting",
                        "plotly_selected",
                        "plotly_hover",
                        "plotly_unhover",
                        "plotly_legenddoubleclick",
                        "plotly_restyle",
                        "plotly_relayout",
                        "plotly_webglcontextlost",
                        "plotly_afterplot",
                        "plotly_autosize",
                        "plotly_deselect",
                        "plotly_doubleclick",
                        "plotly_redraw",
                        "plotly_animated",
                    ]) {{
                        el.on(name, (event) => {{
                            const args = {{
                                ...event,
                                points: event?.points?.map((p) => ({{
                                ...p,
                                fullData: undefined,
                                xaxis: undefined,
                                yaxis: undefined,
                                }})),
                                xaxes: undefined,
                                yaxes: undefined,
                            }};
                            if (callbacks) callbacks[name]?.(JSON.stringify(args));
                        }});
                    }}
                }};

                // Create the plot
                Plotly.react('plot', plotData.data, plotData.layout)
                    .then(function() {{
                        callbacks.plot_ready("Plot initialized");

                        // set_handlers(plotDiv);
                        
                        // Set up event listeners
                        //plotDiv.on('plotly_click', function(data) {{
                        //    callbacks.on_click(JSON.stringify(data));
                        //}});
                        
                        //plotDiv.on('plotly_hover', function(data) {{
                        //    callbacks.on_hover(JSON.stringify(data));
                        //}});
                        
                        //plotDiv.on('plotly_selected', function(data) {{
                        //    callbacks.on_selection(JSON.stringify(data));
                        //}});
                        
                        // Listen for plot updates
                        callbacks.update_plot.connect(function(plotDataJson) {{
                            var newPlotData = JSON.parse(plotDataJson);
                            Plotly.react(plotDiv, newPlotData.data, newPlotData.layout);
                            //plotDiv.innerHTML = plotDataJson;
                        }});
                    }});
            }});
        }});
    </script>
</body>
</html>